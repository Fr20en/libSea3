name: è‡ªåŠ¨å‘å¸ƒ Release

on:
  push:
    tags:
      - 'v*'
      - 'V*'
      - 'release-*'

env:
  NDK_VERSION: r27
  NDK_INSTALL_DIR: ${{ github.workspace }}/android-ndk-r27

jobs:
  create-release:
    name: åˆ›å»º Release å¹¶æ‰“åŒ…æºç 
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 2. è·å– tag ä¿¡æ¯
      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: tag_info
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=${TAG_NAME#v}" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
          
          # è·å–æœ€è¿‘çš„æäº¤ä¿¡æ¯
          COMMITS=$(git log --pretty=format:"- %s" -10)
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      # 3. æ‰“åŒ…æºä»£ç ï¼ˆæ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶ï¼‰
      - name: æ‰“åŒ…æºä»£ç 
        run: |
          mkdir -p release
          
          # åˆ›å»ºå®Œæ•´æºç åŒ…
          tar -czf release/libSea3-${{ steps.tag_info.outputs.tag_name }}-source.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='obj' \
            --exclude='libs' \
            --exclude='build' \
            --exclude='*.o' \
            --exclude='*.so' \
            --exclude='release' \
            .
          
          # åˆ›å»ºä»…å¤´æ–‡ä»¶å’Œ Driver çš„è½»é‡åŒ…
          tar -czf release/libSea3-${{ steps.tag_info.outputs.tag_name }}-headers.tar.gz \
            include/ \
            driver/ \
            README.md \
            LICENSE
          
          # åˆ›å»ºé¢„ç¼–è¯‘åº“åŒ…
          tar -czf release/libSea3-${{ steps.tag_info.outputs.tag_name }}-prebuilt.tar.gz \
            lib/ \
            include/ \
            driver/ \
            jni/ \
            README.md
          
          echo "âœ… æ‰“åŒ…å®Œæˆ"
          ls -lh release/
      
      # 4. ç¼“å­˜ NDKï¼ˆç”¨äºç¼–è¯‘ç¤ºä¾‹ï¼‰
      - name: ç¼“å­˜ NDK
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: ${{ env.NDK_INSTALL_DIR }}
          key: ndk-${{ env.NDK_VERSION }}-linux
      
      # 5. ä¸‹è½½ NDKï¼ˆå¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼‰
      - name: å®‰è£… Android NDK
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          echo "â¬‡ï¸ ä¸‹è½½ NDK ${{ env.NDK_VERSION }} ..."
          wget -q "https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VERSION }}-linux.zip"
          unzip -q android-ndk-${{ env.NDK_VERSION }}-linux.zip -d /tmp
          mv /tmp/android-ndk-${{ env.NDK_VERSION }} ${{ env.NDK_INSTALL_DIR }}
          rm android-ndk-${{ env.NDK_VERSION }}-linux.zip
      
      # 6. ç¼–è¯‘ç¤ºä¾‹ç¨‹åº
      - name: ç¼–è¯‘ç¤ºä¾‹ç¨‹åº
        run: |
          export ANDROID_NDK_HOME=${{ env.NDK_INSTALL_DIR }}
          export PATH=$ANDROID_NDK_HOME:$PATH
          
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘..."
          $ANDROID_NDK_HOME/ndk-build -j$(nproc)
          
          echo "âœ… ç¼–è¯‘å®Œæˆ"
          ls -lh libs/
      
      # 7. æ‰“åŒ…ç¼–è¯‘äº§ç‰©
      - name: æ‰“åŒ…ç¼–è¯‘äº§ç‰©
        run: |
          # æ‰“åŒ…æ‰€æœ‰æ¶æ„çš„å¯æ‰§è¡Œæ–‡ä»¶
          tar -czf release/libSea3-${{ steps.tag_info.outputs.tag_name }}-binaries.tar.gz libs/
          
          # ä¸ºæ¯ä¸ªæ¶æ„å•ç‹¬æ‰“åŒ…
          cd libs
          for arch in */; do
            arch_name=${arch%/}
            tar -czf ../release/libSea3-${{ steps.tag_info.outputs.tag_name }}-${arch_name}.tar.gz $arch_name/
          done
          cd ..
          
          echo "âœ… ç¼–è¯‘äº§ç‰©æ‰“åŒ…å®Œæˆ"
          ls -lh release/
      
      # 8. ç”Ÿæˆ Release è¯´æ˜
      - name: ç”Ÿæˆ Release è¯´æ˜
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          # ğŸ‰ libSea3 ${{ steps.tag_info.outputs.tag_name }}
          
          **å‘å¸ƒæ—¥æœŸ**: ${{ steps.tag_info.outputs.date }}
          
          ## ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          ### æºç åŒ…
          - **libSea3-${{ steps.tag_info.outputs.tag_name }}-source.tar.gz** - å®Œæ•´æºä»£ç ï¼ˆæ¨èï¼‰
          - **libSea3-${{ steps.tag_info.outputs.tag_name }}-headers.tar.gz** - ä»…å¤´æ–‡ä»¶å’Œ Driver
          - **libSea3-${{ steps.tag_info.outputs.tag_name }}-prebuilt.tar.gz** - é¢„ç¼–è¯‘åº“åŒ…
          
          ### ç¼–è¯‘äº§ç‰©
          - **libSea3-${{ steps.tag_info.outputs.tag_name }}-binaries.tar.gz** - æ‰€æœ‰æ¶æ„çš„å¯æ‰§è¡Œæ–‡ä»¶
          - **libSea3-${{ steps.tag_info.outputs.tag_name }}-arm64-v8a.tar.gz** - ARM64 ç‰ˆæœ¬
          - **libSea3-${{ steps.tag_info.outputs.tag_name }}-x86_64.tar.gz** - x86_64 ç‰ˆæœ¬
          
          ## âœ¨ ä¸»è¦ç‰¹æ€§
          
          - âœ… å¤šç§ Driver æ”¯æŒï¼ˆsyscallã€pread64ã€kernelï¼‰
          - âœ… æ”¯æŒ ARM64-v8a å’Œ x86_64 æ¶æ„
          - âœ… GitHub Actions è‡ªåŠ¨æ„å»º
          - âœ… å®Œæ•´çš„å†…å­˜æ“ä½œ API
          - âœ… æŒ‡é’ˆé“¾è‡ªåŠ¨è§£æ
          
          ## ğŸ“ æœ€è¿‘æ›´æ–°
          
          ${{ steps.tag_info.outputs.commits }}
          
          ## ğŸš€ å¿«é€Ÿå¼€å§‹
          
          ```bash
          # ä¸‹è½½æºç åŒ…
          tar -xzf libSea3-${{ steps.tag_info.outputs.tag_name }}-source.tar.gz
          cd libSea3
          
          # ç¼–è¯‘
          export ANDROID_NDK_HOME=/path/to/ndk
          ndk-build
          
          # æˆ–ç›´æ¥ä½¿ç”¨é¢„ç¼–è¯‘ç‰ˆæœ¬
          tar -xzf libSea3-${{ steps.tag_info.outputs.tag_name }}-arm64-v8a.tar.gz
          ```
          
          ## ğŸ“– æ–‡æ¡£
          
          è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·æŸ¥çœ‹ [README.md](https://github.com/AYssu/libSea3/blob/main/README.md)
          
          ## ğŸ’¬ åé¦ˆ
          
          å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿æ [Issue](https://github.com/AYssu/libSea3/issues)
          
          ---
          
          **æ³¨æ„**: æ ¸å¿ƒåº“ä¸ºéƒ¨åˆ†é—­æºï¼Œå•†ä¸šä½¿ç”¨éœ€è·å¾—æˆæƒ
          EOF
          
          cat release_notes.md
      
      # 9. åˆ›å»º GitHub Release
      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          name: libSea3 ${{ steps.tag_info.outputs.tag_name }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            release/libSea3-${{ steps.tag_info.outputs.tag_name }}-source.tar.gz
            release/libSea3-${{ steps.tag_info.outputs.tag_name }}-headers.tar.gz
            release/libSea3-${{ steps.tag_info.outputs.tag_name }}-prebuilt.tar.gz
            release/libSea3-${{ steps.tag_info.outputs.tag_name }}-binaries.tar.gz
            release/libSea3-${{ steps.tag_info.outputs.tag_name }}-arm64-v8a.tar.gz
            release/libSea3-${{ steps.tag_info.outputs.tag_name }}-x86_64.tar.gz
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # 10. è¾“å‡ºæ‘˜è¦
      - name: è¾“å‡ºæ‘˜è¦
        run: |
          echo "### ğŸ‰ Release åˆ›å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: ${{ steps.tag_info.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: ${{ steps.tag_info.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ğŸ“¦ åŒ…å«çš„æ–‡ä»¶:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -lh release/ | awk '{if(NR>1) print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— [æŸ¥çœ‹ Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag_info.outputs.tag_name }})" >> $GITHUB_STEP_SUMMARY

